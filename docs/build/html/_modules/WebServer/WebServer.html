<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebServer.WebServer &#8212; SMB-Sim 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for WebServer.WebServer</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">flask_login</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">render_template</span>
<span class="kn">from</span> <span class="nn">SMB.SMBStation</span> <span class="kn">import</span> <span class="n">SMBStation</span>
<span class="kn">from</span> <span class="nn">SMB.LinColumn</span> <span class="kn">import</span> <span class="n">LinColumn</span>
<span class="kn">from</span> <span class="nn">SMB.NonlinColumn</span> <span class="kn">import</span> <span class="n">NonLinColumn</span>
<span class="kn">from</span> <span class="nn">SMB.Tube</span> <span class="kn">import</span> <span class="n">Tube</span>
<span class="kn">import</span> <span class="nn">mongoengine</span> <span class="k">as</span> <span class="nn">me</span>
<span class="kn">import</span> <span class="nn">paho.mqtt.client</span> <span class="k">as</span> <span class="nn">mqtt</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">WebServer.config</span> <span class="kn">import</span> <span class="n">IED_IP</span>
<span class="kn">import</span> <span class="nn">scipy.integrate</span> <span class="k">as</span> <span class="nn">integrate</span>


<div class="viewcode-block" id="Web_Server"><a class="viewcode-back" href="../../WebServer.html#WebServer.WebServer.Web_Server">[docs]</a><span class="k">def</span> <span class="nf">Web_Server</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class implementing web server logic, including communication with Data Service and Databus and time control of simulation&quot;&quot;&quot;</span>
    <span class="n">station_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
    <span class="n">station</span> <span class="o">=</span> <span class="n">SMBStation</span><span class="p">()</span>
    <span class="n">stationSaveState</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">formInfo</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">liveInfo</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">linCol</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">nonLinCol</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">offlineSimDone</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">offlineSimResult</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">onlineInitDone</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mqttConnection</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">tagMap</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">onlineMemory_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
    <span class="n">onlineMemory</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">latestTimePointInSec</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">tagIdMap</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Data.feedFlowrate&quot;</span><span class="p">:</span> <span class="s2">&quot;101&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.eluentFlowrate&quot;</span><span class="p">:</span> <span class="s2">&quot;102&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.raffinateFlowrate&quot;</span><span class="p">:</span> <span class="s2">&quot;103&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.extractFlowrate&quot;</span><span class="p">:</span> <span class="s2">&quot;104&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.recycleFlowrate&quot;</span><span class="p">:</span> <span class="s2">&quot;105&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.feedConcCompA&quot;</span><span class="p">:</span> <span class="s2">&quot;106&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.feedConcCompB&quot;</span><span class="p">:</span> <span class="s2">&quot;107&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.feedConcCompC&quot;</span><span class="p">:</span> <span class="s2">&quot;108&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.raffinateConcCompA&quot;</span><span class="p">:</span> <span class="s2">&quot;109&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.raffinateConcCompB&quot;</span><span class="p">:</span> <span class="s2">&quot;110&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.raffinateConcCompC&quot;</span><span class="p">:</span> <span class="s2">&quot;111&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.extractConcCompA&quot;</span><span class="p">:</span> <span class="s2">&quot;112&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.extractConcCompB&quot;</span><span class="p">:</span> <span class="s2">&quot;113&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.extractConcCompC&quot;</span><span class="p">:</span> <span class="s2">&quot;114&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.switchTime&quot;</span><span class="p">:</span> <span class="s2">&quot;115&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.timeToSwitch&quot;</span><span class="p">:</span> <span class="s2">&quot;116&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.position&quot;</span><span class="p">:</span> <span class="s2">&quot;117&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.feedPumpRunnig&quot;</span><span class="p">:</span> <span class="s2">&quot;118&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.eluentPumpRunning&quot;</span><span class="p">:</span> <span class="s2">&quot;119&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.raffinatePumpRunning&quot;</span><span class="p">:</span> <span class="s2">&quot;120&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.extractPumpRunning&quot;</span><span class="p">:</span> <span class="s2">&quot;121&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.recyclePumpRunning&quot;</span><span class="p">:</span> <span class="s2">&quot;122&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.feedPumpSetpoint&quot;</span><span class="p">:</span> <span class="s2">&quot;123&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.eluentPumpSetpoint&quot;</span><span class="p">:</span> <span class="s2">&quot;124&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.raffinatePumpSetpoint&quot;</span><span class="p">:</span> <span class="s2">&quot;125&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.extractPumpSetpoint&quot;</span><span class="p">:</span> <span class="s2">&quot;126&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Data.recyclePumpSetpoint&quot;</span><span class="p">:</span> <span class="s2">&quot;127&quot;</span>
    <span class="p">}</span>

    <span class="n">api</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">api</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;super secret key&#39;</span>
    <span class="n">api</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECURITY_PASSWORD_SALT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;super secret salt&#39;</span>
    <span class="n">api</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SESSION_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;development&#39;</span>
    <span class="n">me</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;ChroMo&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;192.168.1.42&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">27017</span><span class="p">)</span>
    <span class="n">login_manager</span> <span class="o">=</span> <span class="n">flask_login</span><span class="o">.</span><span class="n">LoginManager</span><span class="p">()</span>
    <span class="n">login_manager</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">api</span><span class="p">)</span>

    <span class="n">live_data_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
    <span class="n">live_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ext_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ext_labels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">raf_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">raf_labels</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">sim_data_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
    <span class="n">sim_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">IE_USERNAME</span> <span class="o">=</span> <span class="s2">&quot;admin&quot;</span>
    <span class="n">IE_PASSWORD</span> <span class="o">=</span> <span class="s2">&quot;admin&quot;</span>
    <span class="n">BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://&quot;</span> <span class="o">+</span> <span class="n">IED_IP</span>
    <span class="n">timeStart</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span>
    <span class="n">timeDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dataserviceThreadHandler</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">flask_login</span><span class="o">.</span><span class="n">UserMixin</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;User class for flask_login&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@login_manager</span><span class="o">.</span><span class="n">user_loader</span>
    <span class="k">def</span> <span class="nf">load_user</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;User loader for flask_login&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span> <span class="o">==</span> <span class="n">IE_USERNAME</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
        <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">username</span>
        <span class="k">return</span> <span class="n">user</span>

    <span class="nd">@login_manager</span><span class="o">.</span><span class="n">request_loader</span>
    <span class="k">def</span> <span class="nf">request_loader</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Request loader for flask_login&quot;&quot;&quot;</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span> <span class="o">==</span> <span class="n">IE_USERNAME</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
        <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">username</span>
        <span class="k">return</span> <span class="n">user</span>

    <span class="nd">@login_manager</span><span class="o">.</span><span class="n">unauthorized_handler</span>
    <span class="k">def</span> <span class="nf">unauthorized_handler</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Unauthorized handler for flask_login&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span> <span class="mi">401</span>

    <span class="k">def</span> <span class="nf">on_connect</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">userdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">rc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function called on successful MQTT connection&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">mqttConnection</span>
        <span class="n">mqttConnection</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MQTT connection working&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">userdata</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function called on received message from MQTT connection</span>
<span class="sd">        It reads tag ids and creates a tag-id map</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">tagIdMap</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">dataPoint</span> <span class="ow">in</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;connections&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;dataPoints&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;dataPointDefinitions&quot;</span><span class="p">]:</span>
                <span class="n">tagIdMap</span><span class="p">[</span><span class="n">dataPoint</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataPoint</span><span class="o">.</span><span class="n">id</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;message not relevant&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_latest_time_point</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates latest time point of live data, used for time synchronization with simulation&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">ext_labels</span><span class="p">,</span> <span class="n">raf_labels</span><span class="p">,</span> <span class="n">latestTimePointInSec</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">ext_labels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">val</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">latestTimePointInSec</span><span class="p">:</span>
                <span class="n">latestTimePointInSec</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">raf_labels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">val</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">latestTimePointInSec</span><span class="p">:</span>
                <span class="n">latestTimePointInSec</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">check_dataservice_connection</span><span class="p">(</span><span class="n">cookies</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks if connection to Data Service&quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">BASE_URL</span> <span class="o">+</span> <span class="s1">&#39;/DataService/Service/IsRunning&#39;</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;isRunning&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">False</span>


    <span class="k">def</span> <span class="nf">calculate_purity_and_yield</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates purity and yield of simulation and live data&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">onlineMemory</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">station_lock</span><span class="p">,</span> <span class="n">onlineMemory_lock</span>
        <span class="n">resultDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;purity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;purity&quot;</span><span class="p">][</span><span class="s1">&#39;horizon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;purity&quot;</span><span class="p">][</span><span class="s1">&#39;simdata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;purity&quot;</span><span class="p">][</span><span class="s1">&#39;livedata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">][</span><span class="s1">&#39;horizon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">][</span><span class="s1">&#39;simdata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">][</span><span class="s1">&#39;livedata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;purity&quot;</span><span class="p">][</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;purity&quot;</span><span class="p">][</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">][</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">][</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;purity&quot;</span><span class="p">][</span><span class="s1">&#39;simdata&#39;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;purity&quot;</span><span class="p">][</span><span class="s1">&#39;simdata&#39;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">][</span><span class="s1">&#39;simdata&#39;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">][</span><span class="s1">&#39;simdata&#39;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;purity&quot;</span><span class="p">][</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;purity&quot;</span><span class="p">][</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">][</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">][</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timeForYield</span> <span class="o">=</span> <span class="n">formInfo</span><span class="p">[</span><span class="s1">&#39;switchInterval&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">station</span><span class="o">.</span><span class="n">colCount</span>
            <span class="n">stationTimer</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">timer</span>
            <span class="n">compInfo</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">getCompInfo</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">compList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compInfo</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">onlineMemory_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">onlineMemory</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">usedTime</span> <span class="o">=</span> <span class="n">timeForYield</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;livedata&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;horizon&quot;</span><span class="p">:</span>
                    <span class="n">timeSinceLastChange</span> <span class="o">=</span> <span class="n">stationTimer</span><span class="o">-</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;lastChange&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">timeSinceLastChange</span> <span class="o">&lt;</span> <span class="n">timeForYield</span><span class="p">:</span>
                        <span class="n">usedTime</span> <span class="o">=</span> <span class="n">timeSinceLastChange</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;simdata&quot;</span><span class="p">:</span>
                    <span class="n">timeSinceLastChange</span> <span class="o">=</span> <span class="p">(</span><span class="n">stationTimer</span> <span class="o">-</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;horizon&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;lastChange&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">timeSinceLastChange</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">timeSinceLastChange</span> <span class="o">&lt;</span> <span class="n">timeForYield</span><span class="p">:</span>
                        <span class="n">usedTime</span> <span class="o">=</span> <span class="n">timeSinceLastChange</span>
                <span class="n">numOfPointsForYield</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">usedTime</span> <span class="o">//</span> <span class="n">formInfo</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">])</span>
                <span class="n">extConcIntegPerCycle</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">usedTime</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">extConcIntegPerCycle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">integ</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">comp</span><span class="p">[</span><span class="o">-</span><span class="n">numOfPointsForYield</span><span class="p">:],</span> <span class="n">dx</span><span class="o">=</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">])</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">integ</span> <span class="o">/</span> <span class="n">usedTime</span>
                        <span class="n">extConcIntegPerCycle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="n">rafConcIntegPerCycle</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">usedTime</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">extConcIntegPerCycle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">integ</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">comp</span><span class="p">[</span><span class="o">-</span><span class="n">numOfPointsForYield</span><span class="p">:],</span> <span class="n">dx</span><span class="o">=</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">])</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">integ</span> <span class="o">/</span> <span class="n">usedTime</span>
                        <span class="n">rafConcIntegPerCycle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="n">totalSumExt</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">totalSumRaf</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">outExt</span><span class="p">,</span> <span class="n">outRaf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">extConcIntegPerCycle</span><span class="p">,</span> <span class="n">rafConcIntegPerCycle</span><span class="p">):</span>
                    <span class="n">totalSumExt</span> <span class="o">+=</span> <span class="n">outExt</span>
                    <span class="n">totalSumRaf</span> <span class="o">+=</span> <span class="n">outRaf</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">outExt</span><span class="p">,</span> <span class="n">outRaf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">extConcIntegPerCycle</span><span class="p">)),</span> <span class="n">extConcIntegPerCycle</span><span class="p">,</span> <span class="n">rafConcIntegPerCycle</span><span class="p">):</span>
                    <span class="n">feedConc</span> <span class="o">=</span> <span class="n">compInfo</span><span class="p">[</span><span class="n">compList</span><span class="p">[</span><span class="n">idx</span><span class="p">]][</span><span class="s2">&quot;Feed Concentration&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate3&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">feedConc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate2&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">outExt</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate3&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">feedConc</span><span class="p">))</span>
                        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate4&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">outRaf</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate3&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">feedConc</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">totalSumExt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;purity&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outExt</span> <span class="o">/</span> <span class="n">totalSumExt</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;purity&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">totalSumExt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;purity&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outRaf</span> <span class="o">/</span> <span class="n">totalSumRaf</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;purity&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">usedTime</span> <span class="o">=</span> <span class="n">timeForYield</span>
            <span class="n">timeSinceLastChange</span> <span class="o">=</span> <span class="p">(</span><span class="n">stationTimer</span> <span class="o">-</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;horizon&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;lastChange&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">timeSinceLastChange</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">timeSinceLastChange</span> <span class="o">&lt;</span> <span class="n">timeForYield</span><span class="p">:</span>
                <span class="n">usedTime</span> <span class="o">=</span> <span class="n">timeSinceLastChange</span>
            <span class="n">extConcIntegPerCycle</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">compList</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">numOfPoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">],</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">usedTime</span><span class="p">)</span>
                    <span class="n">integ</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="o">-</span><span class="n">numOfPoints</span><span class="p">:],</span> <span class="n">x</span><span class="o">=</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="o">-</span><span class="n">numOfPoints</span><span class="p">:])</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">integ</span> <span class="o">/</span> <span class="n">usedTime</span>
                    <span class="n">extConcIntegPerCycle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">extConcIntegPerCycle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">rafConcIntegPerCycle</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">compList</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">numOfPoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">],</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">usedTime</span><span class="p">)</span>
                    <span class="n">integ</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="o">-</span><span class="n">numOfPoints</span><span class="p">:],</span> <span class="n">x</span><span class="o">=</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="o">-</span><span class="n">numOfPoints</span><span class="p">:])</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">integ</span> <span class="o">/</span> <span class="n">usedTime</span>
                    <span class="n">rafConcIntegPerCycle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rafConcIntegPerCycle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">onlineMemory_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">totalSumExt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">totalSumRaf</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">outExt</span><span class="p">,</span> <span class="n">outRaf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">extConcIntegPerCycle</span><span class="p">,</span> <span class="n">rafConcIntegPerCycle</span><span class="p">):</span>
            <span class="n">totalSumExt</span> <span class="o">+=</span> <span class="n">outExt</span>
            <span class="n">totalSumRaf</span> <span class="o">+=</span> <span class="n">outRaf</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">outExt</span><span class="p">,</span> <span class="n">outRaf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">extConcIntegPerCycle</span><span class="p">)),</span> <span class="n">extConcIntegPerCycle</span><span class="p">,</span> <span class="n">rafConcIntegPerCycle</span><span class="p">):</span>
            <span class="n">feedConc</span> <span class="o">=</span> <span class="n">compInfo</span><span class="p">[</span><span class="n">compList</span><span class="p">[</span><span class="n">idx</span><span class="p">]][</span><span class="s2">&quot;Feed Concentration&quot;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">][</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate2&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">outExt</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate3&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">feedConc</span><span class="p">))</span>
                <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">][</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate4&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">outRaf</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate3&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">feedConc</span><span class="p">))</span>
                <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;purity&quot;</span><span class="p">][</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outExt</span> <span class="o">/</span> <span class="n">totalSumExt</span><span class="p">)</span>
                <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;purity&quot;</span><span class="p">][</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outRaf</span> <span class="o">/</span> <span class="n">totalSumRaf</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">][</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;yield&quot;</span><span class="p">][</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;purity&quot;</span><span class="p">][</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;purity&quot;</span><span class="p">][</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resultDict</span>

    <span class="k">def</span> <span class="nf">get_new_horizon_data</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
        <span class="c1"># returns all sim data from given time label</span>
        <span class="k">nonlocal</span> <span class="n">onlineMemory</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">onlineMemory_lock</span>
        <span class="n">resultDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">onlineMemory_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">label</span><span class="p">]</span>
            <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]):])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]):])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">onlineMemory_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">resultDict</span>

    <span class="k">def</span> <span class="nf">get_new_live_data</span><span class="p">(</span><span class="n">extlabels</span><span class="p">,</span> <span class="n">raflabels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns all live data from given time labels&quot;&quot;&quot;</span>
        <span class="n">resultDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;extlabels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;raflabels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;extractFormated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;raffinateFormated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">onlineMemory_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">extlabels</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">raflabels</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
            <span class="n">compList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;extlabels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">compList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="n">compList</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="n">compList</span><span class="p">[</span><span class="n">idx</span><span class="p">]]):])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extractFormated&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">compList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="n">compList</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;extractFormated&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="n">compList</span><span class="p">[</span><span class="n">idx</span><span class="p">]]):])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;extractFormated&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="n">compList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;raflabels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">compList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="n">compList</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="n">compList</span><span class="p">[</span><span class="n">idx</span><span class="p">]]):])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinateFormated&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">compList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="n">compList</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;raffinateFormated&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="n">compList</span><span class="p">[</span><span class="n">idx</span><span class="p">]]):])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">resultDict</span><span class="p">[</span><span class="s2">&quot;raffinateFormated&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">onlineMemory_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">resultDict</span>

    <span class="k">def</span> <span class="nf">update_online_memory</span><span class="p">(</span><span class="n">responseDict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Saves data into online memory object&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">onlineMemory</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">onlineMemory_lock</span>
        <span class="n">onlineMemory_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]):</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp</span> <span class="o">+</span> <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;simdata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;simdata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">comp</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">])]</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]):]</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;simdata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;simdata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]):]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]):</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp</span> <span class="o">+</span> <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;simdata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;simdata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">comp</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">])]</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]):]</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;simdata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;simdata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]):]</span>
            <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span>
            <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;simdata&#39;</span><span class="p">][</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;simdata&#39;</span><span class="p">][</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="s2">&quot;labels&quot;</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">])]</span>
            <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">][</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]):]</span>
            <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;simdata&#39;</span><span class="p">][</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;simdata&#39;</span><span class="p">][</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]):]</span>
            <span class="k">for</span> <span class="n">comp</span><span class="p">,</span> <span class="n">complabels</span> <span class="ow">in</span> <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">]:</span>
                    <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span> <span class="o">+</span> <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">formInfo</span><span class="p">[</span><span class="s1">&#39;backhorizon&#39;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">comp</span><span class="p">,</span> <span class="n">complabels</span> <span class="ow">in</span> <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">]:</span>
                    <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span> <span class="o">+</span> <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">formInfo</span><span class="p">[</span><span class="s1">&#39;backhorizon&#39;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]):</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp</span> <span class="o">+</span> <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="nb">list</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">idx</span><span class="p">]]):]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]):</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp</span> <span class="o">+</span> <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="nb">list</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">idx</span><span class="p">]]):]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extractFormated&quot;</span><span class="p">]):</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extractFormated&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp</span> <span class="o">+</span> <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;extractFormated&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extractFormated&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extractFormated&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">][</span><span class="nb">list</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">idx</span><span class="p">]]):]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinateFormated&quot;</span><span class="p">]):</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinateFormated&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp</span> <span class="o">+</span> <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;raffinateFormated&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinateFormated&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinateFormated&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">][</span><span class="nb">list</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">[</span><span class="s1">&#39;livedata&#39;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">idx</span><span class="p">]]):]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">onlineMemory_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">online_init</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes all the data objects&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">onlineMemory</span><span class="p">,</span> <span class="n">onlineInitDone</span><span class="p">,</span> <span class="n">sim_dict</span><span class="p">,</span> <span class="n">sim_data_lock</span><span class="p">,</span> <span class="n">station_lock</span>
        <span class="n">responseDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">simDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;compList&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">getCompInfo</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">simDict</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">simDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;liveTime&quot;</span><span class="p">]</span><span class="o">-</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;backhorizon&quot;</span><span class="p">],</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]):</span>
                <span class="n">station</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">simDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">simDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;compList&quot;</span><span class="p">])):</span>
                <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">simDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">simDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;liveTime&quot;</span><span class="p">]</span><span class="o">-</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;backhorizon&quot;</span><span class="p">],</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;liveTime&quot;</span><span class="p">],</span>
                               <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]):</span>  <span class="c1"># loop for each time step</span>
                <span class="n">simDict</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="c1"># saving time lables</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>  <span class="c1"># step</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># loop through components in last column in zone 1</span>
                    <span class="n">simDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># append last conc value of given component</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># loop through components in last column in zone 3</span>
                    <span class="n">simDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># append last conc value of given component</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;liveTime&quot;</span><span class="p">],</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;liveTime&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;horizon&quot;</span><span class="p">],</span>
                               <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]):</span>  <span class="c1"># loop for each time step</span>
                <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="c1"># saving time lables</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>  <span class="c1"># step</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># loop through components in last column in zone 1</span>
                    <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># append last conc value of given component</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># loop through components in last column in zone 3</span>
                    <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># append last conc value of given component</span>
            <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;lastChange&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">timer</span>
            <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;secondLastChange&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">timer</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">onlineMemory_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">onlineMemory</span><span class="p">[</span><span class="s2">&quot;horizon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">responseDict</span>
            <span class="n">onlineMemory</span><span class="p">[</span><span class="s2">&quot;simdata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">simDict</span>
            <span class="n">onlineMemory</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">onlineMemory</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">onlineMemory</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">onlineMemory</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">onlineMemory</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">onlineMemory</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">onlineMemory</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinateFormated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">onlineMemory</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extractFormated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;compList&quot;</span><span class="p">]:</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinateFormated&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">onlineMemory</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extractFormated&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">onlineMemory_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">sim_data_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;compList&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;compList&quot;</span><span class="p">]</span>
            <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;compList&quot;</span><span class="p">])):</span>
                <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sim_data_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">onlineInitDone</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">login_to_Dataservice</span><span class="p">(</span><span class="n">un</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Login to Data Service using direct login, returning authentication token and expire time if successful&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">BASE_URL</span><span class="p">,</span> <span class="n">IE_USERNAME</span><span class="p">,</span> <span class="n">IE_PASSWORD</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">un</span><span class="p">:</span>
            <span class="n">un</span> <span class="o">=</span> <span class="n">IE_USERNAME</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pw</span><span class="p">:</span>
            <span class="n">pw</span> <span class="o">=</span> <span class="n">IE_PASSWORD</span>
        <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;{&quot;username&quot;: &quot;&#39;</span> <span class="o">+</span> <span class="n">un</span> <span class="o">+</span> <span class="s1">&#39;&quot;,&quot;password&quot;: &quot;&#39;</span> <span class="o">+</span> <span class="n">pw</span> <span class="o">+</span> <span class="s1">&#39;&quot;}&#39;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">BASE_URL</span> <span class="o">+</span> <span class="s1">&#39;/device/edge/api/v1/login/direct&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">IE_USERNAME</span> <span class="o">=</span> <span class="n">un</span>
            <span class="n">IE_PASSWORD</span> <span class="o">=</span> <span class="n">pw</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span>
            <span class="n">expiration</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;expires_in&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;authToken&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">token</span><span class="p">),</span> <span class="s1">&#39;sessionExpiryTime&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">expiration</span><span class="p">)}</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get_PLC_variables</span><span class="p">(</span><span class="n">cookies</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sends request to Data Service REST api, returning variables object&quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">BASE_URL</span> <span class="o">+</span> <span class="s1">&#39;/DataService/Variables&#39;</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get_PLC_tags</span><span class="p">(</span><span class="n">cookies</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts variables objects to list of tags&quot;&quot;&quot;</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="n">get_PLC_variables</span><span class="p">(</span><span class="n">cookies</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;variableName&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">[</span><span class="s2">&quot;variables&quot;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">tags</span>

    <span class="k">def</span> <span class="nf">get_data_all</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">cookies</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sends request to Data Service REST api, returning values of given tag starting in given time&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">timeStart</span><span class="p">,</span> <span class="n">formInfo</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="n">get_PLC_variables</span><span class="p">(</span><span class="n">cookies</span><span class="p">)</span>
        <span class="n">varID</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">[</span><span class="s2">&quot;variables&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;variableName&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tag</span><span class="p">:</span>
                <span class="n">varID</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;variableId&quot;</span><span class="p">]</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">varID</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Tag not found&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="s1">&#39;[{&quot;variableId&quot;: &quot;&#39;</span> <span class="o">+</span> <span class="n">varID</span> <span class="o">+</span> <span class="s1">&#39;&quot;,&quot;lastRequestTime&quot;: &quot;&#39;</span> <span class="o">+</span> <span class="n">time</span> <span class="o">+</span> <span class="s1">&#39;&quot;}]&#39;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">BASE_URL</span> <span class="o">+</span> <span class="s1">&#39;/DataService/Data/Delta&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">rdict</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">data3</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;values&quot;</span><span class="p">]]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">Z&#39;</span><span class="p">)</span><span class="o">-</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timeStart</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">Z&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">+</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;liveTime&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;values&quot;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="s2">&quot;lastRequestTime&quot;</span> <span class="ow">in</span> <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">data3</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;lastRequestTime&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">data3</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_data_single</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">cookies</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sends request to Data Service REST api, returning latest values of given tag&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">BASE_URL</span><span class="p">,</span> <span class="n">IE_USERNAME</span><span class="p">,</span> <span class="n">IE_PASSWORD</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="n">get_PLC_variables</span><span class="p">(</span><span class="n">cookies</span><span class="p">)</span>
        <span class="n">varID</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;variables&quot;</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">[</span><span class="s2">&quot;variables&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;variableName&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tag</span><span class="p">:</span>
                    <span class="n">varID</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;variableId&quot;</span><span class="p">]</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">varID</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Tag not found&quot;</span>
            <span class="n">timeFrom</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span>
            <span class="n">timeTo</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">BASE_URL</span> <span class="o">+</span> <span class="s1">&#39;/DataService/Data/&#39;</span> <span class="o">+</span> <span class="n">varID</span> <span class="o">+</span> <span class="s1">&#39;?from=&#39;</span> <span class="o">+</span> <span class="n">timeFrom</span> <span class="o">+</span> <span class="s1">&#39;&amp;to=&#39;</span> <span class="o">+</span> <span class="n">timeTo</span> <span class="o">+</span> <span class="s1">&#39;&amp;order=Descending&#39;</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">rdict</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;values&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">data3</span> <span class="o">=</span> <span class="n">rdict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;values&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">data3</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">update_live_data</span><span class="p">(</span><span class="n">cookies</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function updating all data, getting newest values from Data Service and calling step on SMB station&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">liveInfo</span><span class="p">,</span> <span class="n">timeDict</span><span class="p">,</span> <span class="n">tagMap</span><span class="p">,</span> <span class="n">ext_dict</span><span class="p">,</span> <span class="n">raf_dict</span><span class="p">,</span> <span class="n">raf_labels</span><span class="p">,</span> <span class="n">ext_labels</span><span class="p">,</span>\
            <span class="n">latestTimePointInSec</span><span class="p">,</span> <span class="n">sim_dict</span><span class="p">,</span> <span class="n">onlineInitDone</span><span class="p">,</span> <span class="n">live_data_lock</span><span class="p">,</span> <span class="n">sim_data_lock</span><span class="p">,</span> <span class="n">station_lock</span>
        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tagMap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;NI&quot;</span> <span class="ow">or</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;raffinate&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">9</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">var</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;PumpSetpoint&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">timeDict</span><span class="p">:</span>
                    <span class="n">timeDict</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeStart</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">get_data_all</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">cookies</span><span class="p">,</span> <span class="n">timeDict</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;raffinate&quot;</span><span class="p">):]</span>
                <span class="n">live_data_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">raf_dict</span><span class="p">:</span>
                        <span class="n">raf_dict</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">raf_dict</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">+</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">raf_dict</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">raf_labels</span><span class="p">:</span>
                        <span class="n">raf_labels</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">raf_labels</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">+</span> <span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">raf_labels</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">live_data_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="n">timeDict</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">var</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;extract&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">var</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;PumpSetpoint&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">timeDict</span><span class="p">:</span>
                    <span class="n">timeDict</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeStart</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">get_data_all</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">cookies</span><span class="p">,</span> <span class="n">timeDict</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;extract&quot;</span><span class="p">):]</span>
                <span class="n">live_data_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">ext_dict</span><span class="p">:</span>
                        <span class="n">ext_dict</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">ext_dict</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">+</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ext_dict</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">ext_labels</span><span class="p">:</span>
                        <span class="n">ext_labels</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">ext_labels</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">+</span> <span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ext_labels</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">live_data_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="n">timeDict</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">get_data_single</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">cookies</span><span class="p">)</span>
                <span class="n">liveInfo</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
            <span class="n">calculate_latest_time_point</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">onlineInitDone</span><span class="p">:</span>
                <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="n">sim_data_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;compList&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">getCompInfo</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="k">while</span> <span class="n">station</span><span class="o">.</span><span class="n">timer</span> <span class="o">-</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;horizon&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">latestTimePointInSec</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;countdown&quot;</span> <span class="ow">in</span> <span class="n">stationSaveState</span> <span class="ow">and</span> <span class="n">stationSaveState</span><span class="p">[</span><span class="s2">&quot;countdown&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                        <span class="k">if</span> <span class="s2">&quot;countdown&quot;</span> <span class="ow">in</span> <span class="n">stationSaveState</span><span class="p">:</span>
                            <span class="n">stationSaveState</span><span class="p">[</span><span class="s2">&quot;countdown&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span>
                        <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">timer</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">sim_data_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">convert_data</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a response object to return and saves data to online memory object&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">running</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">tagMap</span><span class="p">,</span> <span class="n">liveInfo</span><span class="p">,</span> <span class="n">ext_dict</span><span class="p">,</span> <span class="n">raf_dict</span><span class="p">,</span> <span class="n">ext_labels</span><span class="p">,</span> <span class="n">raf_labels</span><span class="p">,</span>\
            <span class="n">stationSaveState</span><span class="p">,</span> <span class="n">sim_dict</span><span class="p">,</span> <span class="n">sim_data_lock</span><span class="p">,</span> <span class="n">live_data_lock</span><span class="p">,</span> <span class="n">onlineInitDone</span>
        <span class="k">if</span> <span class="n">onlineInitDone</span><span class="p">:</span>
            <span class="n">sim_data_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">responseDict</span> <span class="o">=</span> <span class="n">sim_dict</span>
                <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;compList&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">getCompInfo</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">sim_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;compList&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">getCompInfo</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;compList&quot;</span><span class="p">])):</span>
                    <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="n">sim_dict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">sim_data_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;raffinateFormated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;extractFormated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;switchPosition&quot;</span><span class="p">]</span>
            <span class="n">sim_data_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;compList&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">ext_dict</span> <span class="ow">and</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">ext_labels</span><span class="p">:</span>
                        <span class="n">extdata4</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">a</span><span class="p">}</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ext_dict</span><span class="p">[</span><span class="n">comp</span><span class="p">],</span> <span class="n">ext_labels</span><span class="p">[</span><span class="n">comp</span><span class="p">])]</span>
                        <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;extractFormated&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extdata4</span><span class="p">)</span>
                        <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ext_dict</span><span class="p">[</span><span class="n">comp</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;extractFormated&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                        <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="k">if</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">raf_dict</span> <span class="ow">and</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">raf_labels</span><span class="p">:</span>
                        <span class="n">rafdata4</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">a</span><span class="p">}</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">raf_dict</span><span class="p">[</span><span class="n">comp</span><span class="p">],</span> <span class="n">raf_labels</span><span class="p">[</span><span class="n">comp</span><span class="p">])]</span>
                        <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;raffinateFormated&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rafdata4</span><span class="p">)</span>
                        <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raf_dict</span><span class="p">[</span><span class="n">comp</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;raffinateFormated&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                        <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="n">raf_dict</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">ext_dict</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;extlabels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ext_labels</span>
                <span class="n">ext_labels</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">][</span><span class="s2">&quot;raflabels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raf_labels</span>
                <span class="n">raf_labels</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">sim_data_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="n">update_online_memory</span><span class="p">(</span><span class="n">responseDict</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">update_station</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates flow rates of SMB station&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">station</span>
        <span class="n">station</span><span class="o">.</span><span class="n">setFlowRateZone</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate1&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateUnits&quot;</span><span class="p">])</span>
        <span class="n">station</span><span class="o">.</span><span class="n">setFlowRateZone</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate2&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateUnits&quot;</span><span class="p">])</span>
        <span class="n">station</span><span class="o">.</span><span class="n">setFlowRateZone</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate3&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateUnits&quot;</span><span class="p">])</span>
        <span class="n">station</span><span class="o">.</span><span class="n">setFlowRateZone</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate4&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateUnits&quot;</span><span class="p">])</span>
        <span class="n">station</span><span class="o">.</span><span class="n">setSwitchInterval</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;switchInterval&quot;</span><span class="p">])</span>
        <span class="n">station</span><span class="o">.</span><span class="n">initCols</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">update_feed_concentrations</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates feed concentrations of SMB station&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">tagMap</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">station_lock</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;calling update feed concentrations&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stationSaveState</span><span class="p">:</span>
            <span class="n">cookies</span> <span class="o">=</span> <span class="n">login_to_Dataservice</span><span class="p">()</span>
            <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">compList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">getCompInfo</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">compList</span><span class="p">:</span>
                    <span class="n">feedConc</span> <span class="o">=</span> <span class="n">get_data_single</span><span class="p">(</span><span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;feed&quot;</span> <span class="o">+</span> <span class="n">comp</span><span class="p">],</span> <span class="n">cookies</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;changing feed of&quot;</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">,</span> <span class="n">feedConc</span><span class="o">*</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;concUnits&quot;</span><span class="p">])</span>
                    <span class="n">station</span><span class="o">.</span><span class="n">updateComponentByName</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">feedConc</span><span class="o">=</span><span class="n">feedConc</span><span class="o">*</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;concUnits&quot;</span><span class="p">])</span>
                <span class="n">station</span><span class="o">.</span><span class="n">initCols</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">fix_flowrates</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates flow rate in zones from flow rates of input streams&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">formInfo</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateRecycle&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateEluent&quot;</span><span class="p">]</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateExtract&quot;</span><span class="p">]</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateFeed&quot;</span><span class="p">]</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate3&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateRaffinate&quot;</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate4&quot;</span><span class="p">]</span><span class="o">-</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateRecycle&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;flow rates dont match up&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_column</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds column to SMB station from form data in request&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">linCol</span><span class="p">,</span> <span class="n">nonLinCol</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">station_lock</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;zone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zone&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;isotherm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;isotherm&quot;</span><span class="p">)</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;colLength&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;colLength&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;colDiameter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;colDiameter&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;porosity&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;porosity&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;deadVol&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;deadVol&quot;</span><span class="p">))</span>
        <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;isotherm&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Lin&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;zone&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
                        <span class="n">station</span><span class="o">.</span><span class="n">addColZone</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span>
                                           <span class="n">LinColumn</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;colLength&quot;</span><span class="p">],</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;colDiameter&quot;</span><span class="p">],</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;porosity&quot;</span><span class="p">]),</span>
                                           <span class="n">Tube</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;deadVol&quot;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">station</span><span class="o">.</span><span class="n">addColZone</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;zone&quot;</span><span class="p">],</span> <span class="n">LinColumn</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;colLength&quot;</span><span class="p">],</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;colDiameter&quot;</span><span class="p">],</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;porosity&quot;</span><span class="p">]),</span> <span class="n">Tube</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;deadVol&quot;</span><span class="p">]))</span>
                <span class="n">linCol</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;isotherm&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Nonlin&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;zone&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
                        <span class="n">station</span><span class="o">.</span><span class="n">addColZone</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span>
                                           <span class="n">NonLinColumn</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;colLength&quot;</span><span class="p">],</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;colDiameter&quot;</span><span class="p">],</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;porosity&quot;</span><span class="p">]),</span>
                                           <span class="n">Tube</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;deadVol&quot;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">station</span><span class="o">.</span><span class="n">addColZone</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;zone&quot;</span><span class="p">],</span> <span class="n">NonLinColumn</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;colLength&quot;</span><span class="p">],</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;colDiameter&quot;</span><span class="p">],</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;porosity&quot;</span><span class="p">]),</span> <span class="n">Tube</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;deadVol&quot;</span><span class="p">]))</span>
                <span class="n">nonLinCol</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_component</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds components to SMB station from form data in request&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">formInfo</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="n">feedConc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;feedConc&quot;</span><span class="p">))</span>
        <span class="n">henryConst</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">linCol</span><span class="p">:</span>
            <span class="n">henryConst</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;henryConst&quot;</span><span class="p">))</span>
        <span class="n">langmuirConst</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">saturCoef</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">nonLinCol</span><span class="p">:</span>
            <span class="n">langmuirConst</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;langmuirConst&quot;</span><span class="p">))</span>
            <span class="n">saturCoef</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;saturCoef&quot;</span><span class="p">))</span>
        <span class="n">disperCoef</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;disperCoef&quot;</span><span class="p">))</span>
        <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">station</span><span class="o">.</span><span class="n">createComponent</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">feedConc</span><span class="o">=</span><span class="n">feedConc</span><span class="p">,</span> <span class="n">henryConst</span><span class="o">=</span><span class="n">henryConst</span><span class="p">,</span> <span class="n">disperCoef</span><span class="o">=</span><span class="n">disperCoef</span><span class="p">,</span> <span class="n">langmuirConst</span><span class="o">=</span><span class="n">langmuirConst</span><span class="p">,</span> <span class="n">saturCoef</span><span class="o">=</span><span class="n">saturCoef</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">periodic_task</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrap function calling given fucntion periodicaly&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">event</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;period&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/smbstation/components/simconfig/simulation&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">delete_simulation_data</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP delete response function for /smbstation/components/simconfig/simulation, deletes simulation&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">linCol</span><span class="p">,</span> <span class="n">nonLinCol</span><span class="p">,</span> <span class="n">offlineSimDone</span><span class="p">,</span> <span class="n">offlineSimResult</span><span class="p">,</span> <span class="n">onlineInitDone</span><span class="p">,</span> <span class="n">stationSaveState</span><span class="p">,</span> \
            <span class="n">liveInfo</span><span class="p">,</span> <span class="n">running</span><span class="p">,</span> <span class="n">mqttConnection</span><span class="p">,</span> <span class="n">tagMap</span><span class="p">,</span> <span class="n">onlineMemory</span><span class="p">,</span> <span class="n">ext_dict</span><span class="p">,</span> <span class="n">ext_labels</span><span class="p">,</span> <span class="n">raf_dict</span><span class="p">,</span> <span class="n">raf_labels</span><span class="p">,</span> <span class="n">timeDict</span><span class="p">,</span> \
            <span class="n">dataserviceThreadHandler</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">station_lock</span><span class="p">,</span> <span class="n">live_data_lock</span><span class="p">,</span> <span class="n">sim_data_lock</span><span class="p">,</span> <span class="n">sim_dict</span>
        <span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">dataserviceThreadHandler</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">station</span>
            <span class="n">station</span> <span class="o">=</span> <span class="n">SMBStation</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">live_data_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ext_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">ext_labels</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">raf_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">raf_labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">live_data_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">sim_data_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sim_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sim_data_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">timeDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">del</span> <span class="n">formInfo</span>
        <span class="n">formInfo</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">linCol</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">nonLinCol</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">offlineSimDone</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">offlineSimResult</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">onlineInitDone</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">stationSaveState</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">liveInfo</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">onlineInitDone</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">mqttConnection</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">tagMap</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">onlineMemory</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;get_main_page&#39;</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/offline/smbstation/components/simconfig/simulation/data&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">get_simulation_offline_data</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get response function for /offline/smbstation/components/simconfig/simulation/data, responses with offline sim data&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">offlineSimDone</span><span class="p">,</span> <span class="n">offlineSimResult</span><span class="p">,</span> <span class="n">station_lock</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">offlineSimDone</span><span class="p">:</span>
            <span class="n">responseDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;compList&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">getCompInfo</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;purities&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;purities&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;purities&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;yields&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;yields&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;yields&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;compList&quot;</span><span class="p">])):</span>
                <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">compInfo</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">getCompInfo</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;simtime&quot;</span><span class="p">],</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]):</span> <span class="c1"># loop for each time step</span>
                    <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="c1"># saving time lables</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">step</span><span class="p">()</span> <span class="c1"># step</span>
                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span> <span class="c1"># loop through components in last column in zone 1</span>
                        <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># append last conc value of given component</span>
                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span> <span class="c1"># loop through components in last column in zone 3</span>
                        <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># append last conc value of given component</span>
                <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;final&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span> <span class="c1"># saves last state of station</span>
                <span class="n">timeForYield</span> <span class="o">=</span> <span class="n">formInfo</span><span class="p">[</span><span class="s1">&#39;switchInterval&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">station</span><span class="o">.</span><span class="n">colCount</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="n">numOfPointsForYield</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeForYield</span><span class="o">//</span><span class="n">formInfo</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">])</span>
            <span class="n">extConcIntegPerCycle</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]:</span>
                <span class="n">integ</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">comp</span><span class="p">[</span><span class="o">-</span><span class="n">numOfPointsForYield</span><span class="p">:],</span> <span class="n">dx</span><span class="o">=</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">])</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">integ</span><span class="o">/</span><span class="n">timeForYield</span>
                <span class="n">extConcIntegPerCycle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="n">rafConcIntegPerCycle</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]:</span>
                <span class="n">integ</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">comp</span><span class="p">[</span><span class="o">-</span><span class="n">numOfPointsForYield</span><span class="p">:],</span> <span class="n">dx</span><span class="o">=</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">])</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">integ</span><span class="o">/</span><span class="n">timeForYield</span>
                <span class="n">rafConcIntegPerCycle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="n">totalSumExt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">totalSumRaf</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">outExt</span><span class="p">,</span> <span class="n">outRaf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">extConcIntegPerCycle</span><span class="p">,</span> <span class="n">rafConcIntegPerCycle</span><span class="p">):</span>
                <span class="n">totalSumExt</span> <span class="o">+=</span> <span class="n">outExt</span>
                <span class="n">totalSumRaf</span> <span class="o">+=</span> <span class="n">outRaf</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">outExt</span><span class="p">,</span> <span class="n">outRaf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">extConcIntegPerCycle</span><span class="p">)),</span> <span class="n">extConcIntegPerCycle</span><span class="p">,</span> <span class="n">rafConcIntegPerCycle</span><span class="p">):</span>
                <span class="n">feedConc</span> <span class="o">=</span> <span class="n">compInfo</span><span class="p">[</span><span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;compList&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]][</span><span class="s2">&quot;Feed Concentration&quot;</span><span class="p">]</span>
                <span class="n">feedFlowRate</span> <span class="o">=</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate3&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate2&quot;</span><span class="p">]</span>
                <span class="n">extFlowRate</span> <span class="o">=</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate2&quot;</span><span class="p">]</span>
                <span class="n">rafFlowRate</span> <span class="o">=</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate3&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate4&quot;</span><span class="p">]</span>
                <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;yields&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">extFlowRate</span><span class="o">*</span><span class="n">outExt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">feedFlowRate</span><span class="o">*</span><span class="n">feedConc</span><span class="p">))</span>
                <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;yields&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">rafFlowRate</span><span class="o">*</span><span class="n">outRaf</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">feedFlowRate</span><span class="o">*</span><span class="n">feedConc</span><span class="p">))</span>
                <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;purities&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outExt</span><span class="o">/</span><span class="n">totalSumExt</span><span class="p">)</span>
                <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;purities&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outRaf</span><span class="o">/</span><span class="n">totalSumRaf</span><span class="p">)</span>
            <span class="n">offlineSimResult</span> <span class="o">=</span> <span class="n">responseDict</span>
            <span class="n">offlineSimDone</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">responseDict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">offlineSimResult</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/online/smbstation/components/simconfig/simulation/initData&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">get_simulation_online_init</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get response function for /online/smbstation/components/simconfig/simulation/initData, initializes data objects and returns online data&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">running</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">onlineInitDone</span><span class="p">,</span> <span class="n">onlineMemory</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">onlineInitDone</span><span class="p">:</span>
            <span class="n">online_init</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">onlineMemory</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/online/smbstation/components/simconfig/simulation/data&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">get_simulation_online_data</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP post response function for /online/smbstation/components/simconfig/simulation/data, responses with online data and updates latest labels&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">running</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">tagMap</span><span class="p">,</span> <span class="n">liveInfo</span><span class="p">,</span> <span class="n">ext_dict</span><span class="p">,</span> <span class="n">raf_dict</span><span class="p">,</span> <span class="n">ext_labels</span><span class="p">,</span> <span class="n">raf_labels</span><span class="p">,</span>\
            <span class="n">stationSaveState</span><span class="p">,</span> <span class="n">sim_dict</span><span class="p">,</span> <span class="n">sim_data_lock</span><span class="p">,</span> <span class="n">live_data_lock</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
        <span class="n">simLabel</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="s2">&quot;simLabel&quot;</span><span class="p">])</span>
        <span class="n">responseDict</span> <span class="o">=</span> <span class="n">get_new_horizon_data</span><span class="p">(</span><span class="n">simLabel</span><span class="p">)</span>
        <span class="n">liveExtLabels</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;liveExtLabels&quot;</span><span class="p">]</span>
        <span class="n">liveRafLabels</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="s2">&quot;liveRafLabels&quot;</span><span class="p">]</span>
        <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;livedata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_new_live_data</span><span class="p">(</span><span class="n">liveExtLabels</span><span class="p">,</span> <span class="n">liveRafLabels</span><span class="p">)</span>
        <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">switchState</span>
        <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;timeToSwitch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">countdown</span>
        <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;keepChangesAnswerRequest&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;countdown&quot;</span> <span class="ow">in</span> <span class="n">stationSaveState</span> <span class="ow">and</span> <span class="n">stationSaveState</span><span class="p">[</span><span class="s2">&quot;countdown&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;keepChangesAnswerRequest&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;liveInfo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">liveInfo</span>
        <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;compList&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">getCompInfo</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">responseDict</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/online/smbstation/components/simconfig/simulation/changesCommited&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">get_simulation_online_change_commit</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get response function for /online/smbstation/components/simconfig/simulation/changesCommited, responses with whether changes time period already ran out&quot;&quot;&quot;</span>
        <span class="n">responseDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s2">&quot;countdown&quot;</span> <span class="ow">in</span> <span class="n">stationSaveState</span> <span class="ow">and</span> <span class="n">stationSaveState</span><span class="p">[</span><span class="s2">&quot;countdown&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;commit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;commit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">responseDict</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/online/smbstation/components/simconfig/simulation/purityandyield&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">get_simulation_online_purity_and_yield</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get response function for /online/smbstation/components/simconfig/simulation/purityandyield, responses with purity and yield information&quot;&quot;&quot;</span>
        <span class="n">responseDict</span> <span class="o">=</span> <span class="n">calculate_purity_and_yield</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">responseDict</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/online/smbstation/components/simconfig/simulation&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">get_simulation_online</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get response function for /online/smbstation/components/simconfig/simulation, responses with online simulation page&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">running</span><span class="p">,</span> <span class="n">formInfo</span>
        <span class="k">if</span> <span class="n">running</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;OnlineSimulationPage.html&#39;</span><span class="p">,</span> <span class="n">formInfo</span><span class="o">=</span><span class="n">formInfo</span><span class="p">,</span> <span class="n">compInfo</span><span class="o">=</span><span class="n">station</span><span class="o">.</span><span class="n">getCompInfo</span><span class="p">(),</span> <span class="n">auth</span><span class="o">=</span><span class="n">flask_login</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;No simulation running&quot;</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/offline/smbstation/components/simconfig/export&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">get_export</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get response function for /offline/smbstation/components/simconfig/export, responses with json string of sim settings&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">station_lock</span>
        <span class="n">export</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">export</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">getColInfo</span><span class="p">()</span>
            <span class="n">export</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">getCompInfo</span><span class="p">()</span>
            <span class="n">export</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">getSettingsInfo</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">export</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/offline/import&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">get_import</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get response function for /offline/import, responses with offline import page&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;Import.html&#39;</span><span class="p">,</span> <span class="n">online</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/offline/import&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">post_import</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP post response function for /offline/import, imports settings from import string&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">linCol</span><span class="p">,</span> <span class="n">nonLinCol</span><span class="p">,</span> <span class="n">station_lock</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;importString&quot;</span><span class="p">))</span>
            <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">][</span><span class="n">zone</span><span class="p">]),</span><span class="mi">2</span><span class="p">):</span>
                        <span class="n">length</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">][</span><span class="n">zone</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Length&#39;</span><span class="p">]</span>
                        <span class="n">diameter</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">][</span><span class="n">zone</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Diameter&#39;</span><span class="p">]</span>
                        <span class="n">porosity</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">][</span><span class="n">zone</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Porority&#39;</span><span class="p">]</span>
                        <span class="n">deadVolume</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">][</span><span class="n">zone</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;deadVolume&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">][</span><span class="n">zone</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Column Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;EDM with Linear isotherm&#39;</span><span class="p">:</span>
                            <span class="n">station</span><span class="o">.</span><span class="n">addColZone</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">zone</span><span class="p">),</span> <span class="n">LinColumn</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">diameter</span><span class="p">,</span> <span class="n">porosity</span><span class="p">),</span> <span class="n">Tube</span><span class="p">(</span><span class="n">deadVolume</span><span class="p">))</span>
                            <span class="n">linCol</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">][</span><span class="n">zone</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Column Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;EDM with Noncompetetive Langmuir isotherm&#39;</span><span class="p">:</span>
                            <span class="n">station</span><span class="o">.</span><span class="n">addColZone</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">zone</span><span class="p">),</span> <span class="n">NonLinColumn</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">diameter</span><span class="p">,</span> <span class="n">porosity</span><span class="p">),</span> <span class="n">Tube</span><span class="p">(</span><span class="n">deadVolume</span><span class="p">))</span>
                            <span class="n">nonLinCol</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">]:</span>
                    <span class="n">feedConc</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="s1">&#39;Feed Concentration&#39;</span><span class="p">]</span>
                    <span class="n">henryConst</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="s1">&#39;Henry Constant&#39;</span><span class="p">]</span>
                    <span class="n">langmuirConst</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="s1">&#39;Langmuir Constant&#39;</span><span class="p">]</span>
                    <span class="n">saturCoef</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="s1">&#39;Saturation Coefficient&#39;</span><span class="p">]</span>
                    <span class="n">disperCoef</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="s1">&#39;Dispersion Coefficient&#39;</span><span class="p">]</span>
                    <span class="n">station</span><span class="o">.</span><span class="n">createComponent</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">feedConc</span><span class="o">=</span><span class="n">feedConc</span><span class="p">,</span> <span class="n">henryConst</span><span class="o">=</span><span class="n">henryConst</span><span class="p">,</span> <span class="n">disperCoef</span><span class="o">=</span><span class="n">disperCoef</span><span class="p">,</span> <span class="n">langmuirConst</span><span class="o">=</span><span class="n">langmuirConst</span><span class="p">,</span> <span class="n">saturCoef</span><span class="o">=</span><span class="n">saturCoef</span><span class="p">)</span>
                <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">][</span><span class="s1">&#39;Flow Rate&#39;</span><span class="p">][</span><span class="s1">&#39;1&#39;</span><span class="p">]</span>
                <span class="n">station</span><span class="o">.</span><span class="n">setFlowRateZone</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">][</span><span class="s1">&#39;Flow Rate&#39;</span><span class="p">][</span><span class="s1">&#39;1&#39;</span><span class="p">])</span>
                <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">][</span><span class="s1">&#39;Flow Rate&#39;</span><span class="p">][</span><span class="s1">&#39;2&#39;</span><span class="p">]</span>
                <span class="n">station</span><span class="o">.</span><span class="n">setFlowRateZone</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">][</span><span class="s1">&#39;Flow Rate&#39;</span><span class="p">][</span><span class="s1">&#39;2&#39;</span><span class="p">])</span>
                <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">][</span><span class="s1">&#39;Flow Rate&#39;</span><span class="p">][</span><span class="s1">&#39;3&#39;</span><span class="p">]</span>
                <span class="n">station</span><span class="o">.</span><span class="n">setFlowRateZone</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">][</span><span class="s1">&#39;Flow Rate&#39;</span><span class="p">][</span><span class="s1">&#39;3&#39;</span><span class="p">])</span>
                <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">][</span><span class="s1">&#39;Flow Rate&#39;</span><span class="p">][</span><span class="s1">&#39;4&#39;</span><span class="p">]</span>
                <span class="n">station</span><span class="o">.</span><span class="n">setFlowRateZone</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">][</span><span class="s1">&#39;Flow Rate&#39;</span><span class="p">][</span><span class="s1">&#39;4&#39;</span><span class="p">])</span>
                <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;switchInterval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">][</span><span class="s1">&#39;Switch Interval&#39;</span><span class="p">]</span>
                <span class="n">station</span><span class="o">.</span><span class="n">setSwitchInterval</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">][</span><span class="s1">&#39;Switch Interval&#39;</span><span class="p">])</span>
                <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">][</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span>
                <span class="n">station</span><span class="o">.</span><span class="n">setdt</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">][</span><span class="s1">&#39;dt&#39;</span><span class="p">])</span>
                <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;Nx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">][</span><span class="s1">&#39;Nx&#39;</span><span class="p">]</span>
                <span class="n">station</span><span class="o">.</span><span class="n">setNx</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">][</span><span class="s1">&#39;Nx&#39;</span><span class="p">])</span>
                <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;simtime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">][</span><span class="s1">&#39;timer&#39;</span><span class="p">]</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;get_SMB&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;Import.html&#39;</span><span class="p">,</span> <span class="n">importLink</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;post_import&#39;</span><span class="p">),</span> <span class="n">error</span><span class="o">=</span><span class="s2">&quot;Something went wrong with import - Try again&quot;</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/online/import&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">get_import_online</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get response function for /online/import, responses with online import page&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;Import.html&#39;</span><span class="p">,</span> <span class="n">online</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/online/import&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">post_import_online</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP post response function for /online/import, imports settings from import string&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">linCol</span><span class="p">,</span> <span class="n">nonLinCol</span><span class="p">,</span> <span class="n">station_lock</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;importString&quot;</span><span class="p">))</span>
            <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">][</span><span class="n">zone</span><span class="p">]),</span><span class="mi">2</span><span class="p">):</span>
                        <span class="n">length</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">][</span><span class="n">zone</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Length&#39;</span><span class="p">]</span>
                        <span class="n">diameter</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">][</span><span class="n">zone</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Diameter&#39;</span><span class="p">]</span>
                        <span class="n">porosity</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">][</span><span class="n">zone</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Porority&#39;</span><span class="p">]</span>
                        <span class="n">deadVolume</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">][</span><span class="n">zone</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;deadVolume&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">][</span><span class="n">zone</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Column Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;EDM with Linear isotherm&#39;</span><span class="p">:</span>
                            <span class="n">station</span><span class="o">.</span><span class="n">addColZone</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">zone</span><span class="p">),</span> <span class="n">LinColumn</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">diameter</span><span class="p">,</span> <span class="n">porosity</span><span class="p">),</span> <span class="n">Tube</span><span class="p">(</span><span class="n">deadVolume</span><span class="p">))</span>
                            <span class="n">linCol</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">][</span><span class="n">zone</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Column Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;EDM with Noncompetetive Langmuir isotherm&#39;</span><span class="p">:</span>
                            <span class="n">station</span><span class="o">.</span><span class="n">addColZone</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">zone</span><span class="p">),</span> <span class="n">NonLinColumn</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">diameter</span><span class="p">,</span> <span class="n">porosity</span><span class="p">),</span> <span class="n">Tube</span><span class="p">(</span><span class="n">deadVolume</span><span class="p">))</span>
                            <span class="n">nonLinCol</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">]:</span>
                    <span class="n">henryConst</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="s1">&#39;Henry Constant&#39;</span><span class="p">]</span>
                    <span class="n">langmuirConst</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="s1">&#39;Langmuir Constant&#39;</span><span class="p">]</span>
                    <span class="n">saturCoef</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="s1">&#39;Saturation Coefficient&#39;</span><span class="p">]</span>
                    <span class="n">disperCoef</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="s1">&#39;Dispersion Coefficient&#39;</span><span class="p">]</span>
                    <span class="n">station</span><span class="o">.</span><span class="n">createComponent</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">henryConst</span><span class="o">=</span><span class="n">henryConst</span><span class="p">,</span> <span class="n">disperCoef</span><span class="o">=</span><span class="n">disperCoef</span><span class="p">,</span> <span class="n">langmuirConst</span><span class="o">=</span><span class="n">langmuirConst</span><span class="p">,</span> <span class="n">saturCoef</span><span class="o">=</span><span class="n">saturCoef</span><span class="p">)</span>
                <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">][</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span>
                <span class="n">station</span><span class="o">.</span><span class="n">setdt</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">][</span><span class="s1">&#39;dt&#39;</span><span class="p">])</span>
                <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;Nx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">][</span><span class="s1">&#39;Nx&#39;</span><span class="p">]</span>
                <span class="n">station</span><span class="o">.</span><span class="n">setNx</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;settings&#39;</span><span class="p">][</span><span class="s1">&#39;Nx&#39;</span><span class="p">])</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;get_SMB_online&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;Import.html&#39;</span><span class="p">,</span> <span class="n">online</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="s2">&quot;Something went wrong with import - Try again&quot;</span><span class="p">)</span>


    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/offline/smbstation/components&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">get_components</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get response function for /offline/smbstation/components, response with offline adding components page&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">running</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;AddingComponents.html&#39;</span><span class="p">,</span> <span class="n">compInfo</span><span class="o">=</span><span class="n">station</span><span class="o">.</span><span class="n">getCompInfo</span><span class="p">(),</span> <span class="n">linCol</span><span class="o">=</span><span class="n">linCol</span><span class="p">,</span>
                               <span class="n">nonLinCol</span><span class="o">=</span><span class="n">nonLinCol</span><span class="p">,</span> <span class="n">running</span><span class="o">=</span><span class="n">running</span><span class="p">,</span> <span class="n">online</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/offline/smbstation/components&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">post_add_component</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP post response function for /offline/smbstation/components, imports components from form&quot;&quot;&quot;</span>
        <span class="n">add_component</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;get_components&#39;</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/online/smbstation/components&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">get_components_online</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get response function for /online/smbstation/components, response with online adding components page&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">running</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;AddingComponents.html&#39;</span><span class="p">,</span> <span class="n">compInfo</span><span class="o">=</span><span class="n">station</span><span class="o">.</span><span class="n">getCompInfo</span><span class="p">(),</span> <span class="n">linCol</span><span class="o">=</span><span class="n">linCol</span><span class="p">,</span>
                               <span class="n">nonLinCol</span><span class="o">=</span><span class="n">nonLinCol</span><span class="p">,</span> <span class="n">running</span><span class="o">=</span><span class="n">running</span><span class="p">,</span> <span class="n">online</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/online/smbstation/components&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">post_add_component_online</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP post response function for /online/smbstation/components, imports components from form&quot;&quot;&quot;</span>
        <span class="n">add_component</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;get_components_online&#39;</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/offline/peimport&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">get_pe_import</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get response function for /offline/peimport, returns offline import page for parameter estimator string&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;ImportPE.html&#39;</span><span class="p">,</span> <span class="n">importUrl</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;post_pe_import&#39;</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/offline/peimport&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">post_pe_import</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP post response function for /offline/peimport, imports settings from import string&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">running</span><span class="p">,</span> <span class="n">linCol</span><span class="p">,</span> <span class="n">nonLinCol</span><span class="p">,</span> <span class="n">station_lock</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resData</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resImportString&quot;</span><span class="p">))</span>
            <span class="n">expData</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;expImportString&quot;</span><span class="p">))</span>
            <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">station</span><span class="o">.</span><span class="n">setPorosity</span><span class="p">(</span><span class="n">resData</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;porosity&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">resData</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;compparams&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resData</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;compparams&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">station</span><span class="o">.</span><span class="n">updateComponentByName</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">henryConst</span><span class="o">=</span><span class="n">resData</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;compparams&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">disperCoef</span><span class="o">=</span><span class="n">resData</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;compparams&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">station</span><span class="o">.</span><span class="n">updateComponentByName</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">langmuirConst</span><span class="o">=</span><span class="n">resData</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;compparams&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">disperCoef</span><span class="o">=</span><span class="n">resData</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;compparams&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                                      <span class="n">saturCoef</span><span class="o">=</span><span class="n">resData</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;compparams&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">expData</span><span class="p">[</span><span class="s2">&quot;components&quot;</span><span class="p">]:</span>
                    <span class="n">station</span><span class="o">.</span><span class="n">updateComponentByName</span><span class="p">(</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">feedConc</span><span class="o">=</span><span class="n">comp</span><span class="p">[</span><span class="s2">&quot;feedConcentration&quot;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
                    <span class="n">station</span><span class="o">.</span><span class="n">addColZone</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="n">LinColumn</span><span class="p">(</span><span class="n">expData</span><span class="p">[</span><span class="s2">&quot;columnLength&quot;</span><span class="p">],</span> <span class="n">expData</span><span class="p">[</span><span class="s2">&quot;columnDiameter&quot;</span><span class="p">],</span> <span class="n">resData</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s2">&quot;porosity&quot;</span><span class="p">]),</span>
                                       <span class="n">Tube</span><span class="p">(</span><span class="n">expData</span><span class="p">[</span><span class="s2">&quot;deadVolume&quot;</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;ImportPE.html&#39;</span><span class="p">,</span> <span class="n">importUrl</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;post_pe_import&#39;</span><span class="p">),</span> <span class="n">error</span><span class="o">=</span><span class="s2">&quot;Bad Import&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;get_SMB&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;ImportPE.html&#39;</span><span class="p">,</span> <span class="n">importUrl</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;post_pe_import&#39;</span><span class="p">),</span> <span class="n">error</span><span class="o">=</span><span class="s2">&quot;Bad Import&quot;</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/online/peimport&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">get_pe_import_online</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get response function for /online/peimport, returns online import page for parameter estimator string&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;ImportPE.html&#39;</span><span class="p">,</span> <span class="n">importUrl</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;post_pe_import_online&#39;</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/online/peimport&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">post_pe_import_online</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;http post response function for /online/peimport, imports settings from import string&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">running</span><span class="p">,</span> <span class="n">linCol</span><span class="p">,</span> <span class="n">nonLinCol</span><span class="p">,</span> <span class="n">station_lock</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resData</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resImportString&quot;</span><span class="p">))</span>
            <span class="n">expData</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;expImportString&quot;</span><span class="p">))</span>
            <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">station</span><span class="o">.</span><span class="n">setPorosity</span><span class="p">(</span><span class="n">resData</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;porosity&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">resData</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;compparams&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resData</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;compparams&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">station</span><span class="o">.</span><span class="n">updateComponentByName</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">henryConst</span><span class="o">=</span><span class="n">resData</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;compparams&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">disperCoef</span><span class="o">=</span><span class="n">resData</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;compparams&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">station</span><span class="o">.</span><span class="n">updateComponentByName</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">langmuirConst</span><span class="o">=</span><span class="n">resData</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;compparams&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">disperCoef</span><span class="o">=</span><span class="n">resData</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;compparams&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                                      <span class="n">saturCoef</span><span class="o">=</span><span class="n">resData</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s1">&#39;compparams&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
                    <span class="n">station</span><span class="o">.</span><span class="n">addColZone</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="n">LinColumn</span><span class="p">(</span><span class="n">expData</span><span class="p">[</span><span class="s2">&quot;columnLength&quot;</span><span class="p">],</span> <span class="n">expData</span><span class="p">[</span><span class="s2">&quot;columnDiameter&quot;</span><span class="p">],</span> <span class="n">resData</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">][</span><span class="s2">&quot;porosity&quot;</span><span class="p">]),</span>
                                       <span class="n">Tube</span><span class="p">(</span><span class="n">expData</span><span class="p">[</span><span class="s2">&quot;deadVolume&quot;</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;ImportPE.html&#39;</span><span class="p">,</span> <span class="n">importUrl</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;post_pe_import_online&#39;</span><span class="p">),</span> <span class="n">error</span><span class="o">=</span><span class="s2">&quot;Bad Import&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;get_SMB_online&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;ImportPE.html&#39;</span><span class="p">,</span> <span class="n">importUrl</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;post_pe_import_online&#39;</span><span class="p">),</span> <span class="n">error</span><span class="o">=</span><span class="s2">&quot;Bad Import&quot;</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/smbstation/components/&lt;idx&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">delete_component</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP delete response function for /smbstation/components/&lt;idx&gt;, removes component&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">linCol</span><span class="p">,</span> <span class="n">nonLinCol</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">station_lock</span>
        <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">station</span><span class="o">.</span><span class="n">delComponent</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">204</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">)</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get response function for /logout, logs out user&quot;&quot;&quot;</span>
        <span class="n">flask_login</span><span class="o">.</span><span class="n">logout_user</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;get_main_page&#39;</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">get_login_page</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get and post response function for /login, returns login page and logs in user&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">IE_PASSWORD</span><span class="p">,</span> <span class="n">IE_USERNAME</span><span class="p">,</span> <span class="n">api</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">flask_login</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;get_main_page&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;login.html&#39;</span><span class="p">)</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">login_to_Dataservice</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
            <span class="n">api</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">32</span><span class="p">))</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
            <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">username</span>
            <span class="n">flask_login</span><span class="o">.</span><span class="n">login_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;get_main_page&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;login.html&#39;</span><span class="p">,</span> <span class="n">badLogin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">get_main_page</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get response function for /, returns main page&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;Index.html&#39;</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">flask_login</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/offline/smbstation&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">get_SMB</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get response function for /offline/smbstation, returns smb station page&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">running</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;SMBStation.html&#39;</span><span class="p">,</span> <span class="n">stationInfo</span><span class="o">=</span><span class="n">station</span><span class="o">.</span><span class="n">getColInfo</span><span class="p">(),</span> <span class="n">readyNext</span><span class="o">=</span><span class="n">station</span><span class="o">.</span><span class="n">getZoneReady</span><span class="p">(),</span>
                               <span class="n">formInfo</span><span class="o">=</span><span class="n">formInfo</span><span class="p">,</span> <span class="n">running</span><span class="o">=</span><span class="n">running</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/offline/smbstation/components/simconfig&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">get_SMB_config</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get response function for /offline/smbstation/components/simconfig, returns simulation definition page for offline sim&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">running</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;SimulationDefinition.html&#39;</span><span class="p">,</span> <span class="n">stationInfo</span><span class="o">=</span><span class="n">station</span><span class="o">.</span><span class="n">getColInfo</span><span class="p">(),</span> <span class="n">readyNext</span><span class="o">=</span><span class="n">station</span><span class="o">.</span><span class="n">getZoneReady</span><span class="p">(),</span> <span class="n">formInfo</span><span class="o">=</span><span class="n">formInfo</span><span class="p">,</span> <span class="n">running</span><span class="o">=</span><span class="n">running</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/offline/smbstation/components/simconfig&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">post_create_SMB</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP post response function for /offline/smbstation/components/simconfig, creates simulation&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">station_lock</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRate1&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRate2&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRate3&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRate4&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;switchInterval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;switchInterval&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dt&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;Nx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Nx&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;simtime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;simtime&quot;</span><span class="p">))</span>
        <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">station</span><span class="o">.</span><span class="n">setFlowRateZone</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate1&quot;</span><span class="p">])</span>
            <span class="n">station</span><span class="o">.</span><span class="n">setFlowRateZone</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate2&quot;</span><span class="p">])</span>
            <span class="n">station</span><span class="o">.</span><span class="n">setFlowRateZone</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate3&quot;</span><span class="p">])</span>
            <span class="n">station</span><span class="o">.</span><span class="n">setFlowRateZone</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate4&quot;</span><span class="p">])</span>
            <span class="n">station</span><span class="o">.</span><span class="n">setSwitchInterval</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;switchInterval&quot;</span><span class="p">])</span>
            <span class="n">station</span><span class="o">.</span><span class="n">setdt</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">])</span>
            <span class="n">station</span><span class="o">.</span><span class="n">setNx</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;Nx&quot;</span><span class="p">])</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;get_simulation&#39;</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/offline/column&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">post_add_column</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP post response function for /offline/column, adds column to smb station&quot;&quot;&quot;</span>
        <span class="n">add_column</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;get_SMB&#39;</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/column/&lt;zone&gt;/&lt;idx&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">delete_column</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP delete response function for /column/&lt;zone&gt;/&lt;idx&gt;, removes column to smb station&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">linCol</span><span class="p">,</span> <span class="n">nonLinCol</span><span class="p">,</span> <span class="n">formInfo</span>
        <span class="n">station</span><span class="o">.</span><span class="n">delColZone</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">zone</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">204</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/online/smbstation/components/plcmaping&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">get_online_plcmaping</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get response function for /online/smbstation/components/plcmaping, returns tag mapping page for online sim&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">station</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">get_PLC_tags</span><span class="p">(</span><span class="n">login_to_Dataservice</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;tagMapping.html&quot;</span><span class="p">,</span> <span class="n">formInfo</span><span class="o">=</span><span class="n">formInfo</span><span class="p">,</span> <span class="n">plcTags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span> <span class="n">compList</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">getCompInfo</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;tagMapping.html&quot;</span><span class="p">,</span> <span class="n">formInfo</span><span class="o">=</span><span class="n">formInfo</span><span class="p">,</span> <span class="n">plcTags</span><span class="o">=</span><span class="p">[],</span> <span class="n">compList</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">getCompInfo</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">error</span><span class="o">=</span><span class="s2">&quot;Failed to establish connection to Dataservice.&quot;</span><span class="p">)</span>


    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/online/smbstation/components/plcmaping&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">post_online_plcmaping</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP post response function for /online/smbstation/components/plcmaping, maps tags to sim parameters and initializes sim&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">tagMap</span><span class="p">,</span> <span class="n">timeStart</span><span class="p">,</span> <span class="n">dataserviceThreadHandler</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">running</span><span class="p">,</span> <span class="n">station_lock</span>
        <span class="n">compList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">getCompInfo</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">cookies</span> <span class="o">=</span> <span class="n">login_to_Dataservice</span><span class="p">()</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateUnits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRateUnits&quot;</span><span class="p">))</span>
        <span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;flowRateEluent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRateEluent&quot;</span><span class="p">)</span>
        <span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;flowRateExtract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRateExtract&quot;</span><span class="p">)</span>
        <span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;flowRateFeed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRateFeed&quot;</span><span class="p">)</span>
        <span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;flowRateRaffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRateRaffinate&quot;</span><span class="p">)</span>
        <span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;flowRateRecycle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRateRecycle&quot;</span><span class="p">)</span>
        <span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;eluent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eluent&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateEluent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_data_single</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eluent&quot;</span><span class="p">),</span> <span class="n">cookies</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateEluent&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extract&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateExtract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_data_single</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extract&quot;</span><span class="p">),</span> <span class="n">cookies</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateExtract&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;feed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;feed&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateFeed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_data_single</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;feed&quot;</span><span class="p">),</span> <span class="n">cookies</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateFeed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;raffinate&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateRaffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_data_single</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;raffinate&quot;</span><span class="p">),</span> <span class="n">cookies</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateRaffinate&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;recycle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;recycle&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateRecycle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_data_single</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;recycle&quot;</span><span class="p">),</span> <span class="n">cookies</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateRecycle&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">fix_flowrates</span><span class="p">()</span>
        <span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;switchPosition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;switchPosition&quot;</span><span class="p">)</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;switchPosition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_data_single</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;switchPosition&quot;</span><span class="p">),</span> <span class="n">cookies</span><span class="p">)</span>
        <span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;switchInterval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;switchIntervalTag&quot;</span><span class="p">)</span>
        <span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;timeToSwitch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeToSwitchTag&quot;</span><span class="p">)</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;switchInterval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_data_single</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;switchIntervalTag&quot;</span><span class="p">),</span> <span class="n">cookies</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dt&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;Nx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Nx&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;horizon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;horizon&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;backhorizon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backhorizon&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;liveTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;liveTime&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;concUnits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;concUnits&quot;</span><span class="p">))</span>
        <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">compList</span><span class="p">:</span>
                <span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;extract&quot;</span> <span class="o">+</span> <span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extract&quot;</span> <span class="o">+</span> <span class="n">comp</span><span class="p">)</span>
                <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;extract&quot;</span> <span class="o">+</span> <span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_data_single</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extract&quot;</span> <span class="o">+</span> <span class="n">comp</span><span class="p">),</span> <span class="n">cookies</span><span class="p">)</span>
                <span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;feed&quot;</span> <span class="o">+</span> <span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;feed&quot;</span> <span class="o">+</span> <span class="n">comp</span><span class="p">)</span>
                <span class="n">feedConc</span> <span class="o">=</span> <span class="n">get_data_single</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;feed&quot;</span> <span class="o">+</span> <span class="n">comp</span><span class="p">),</span> <span class="n">cookies</span><span class="p">)</span>
                <span class="n">station</span><span class="o">.</span><span class="n">updateComponentByName</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">feedConc</span><span class="o">=</span><span class="n">feedConc</span><span class="o">*</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;concUnits&quot;</span><span class="p">])</span>
                <span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;raffinate&quot;</span> <span class="o">+</span> <span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;raffinate&quot;</span> <span class="o">+</span> <span class="n">comp</span><span class="p">)</span>
                <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;raffinate&quot;</span> <span class="o">+</span> <span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_data_single</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;raffinate&quot;</span> <span class="o">+</span> <span class="n">comp</span><span class="p">),</span> <span class="n">cookies</span><span class="p">)</span>
            <span class="nb">print</span>
            <span class="n">station</span><span class="o">.</span><span class="n">setFlowRateZone</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate1&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateUnits&quot;</span><span class="p">])</span>
            <span class="n">station</span><span class="o">.</span><span class="n">setFlowRateZone</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate2&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateUnits&quot;</span><span class="p">])</span>
            <span class="n">station</span><span class="o">.</span><span class="n">setFlowRateZone</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate3&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateUnits&quot;</span><span class="p">])</span>
            <span class="n">station</span><span class="o">.</span><span class="n">setFlowRateZone</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate4&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateUnits&quot;</span><span class="p">])</span>
            <span class="n">station</span><span class="o">.</span><span class="n">setSwitchInterval</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;switchInterval&quot;</span><span class="p">])</span>
            <span class="n">station</span><span class="o">.</span><span class="n">setdt</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">])</span>
            <span class="n">station</span><span class="o">.</span><span class="n">setNx</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;Nx&quot;</span><span class="p">])</span>
            <span class="n">station</span><span class="o">.</span><span class="n">initCols</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">timeStart</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">dataserviceThreadHandler</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">periodic_task</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">update_live_data</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">login_to_Dataservice</span><span class="p">()),</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;BackgroundUpdateData&quot;</span><span class="p">)</span>
        <span class="n">dataserviceThreadHandler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">periodic_task</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">update_feed_concentrations</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">name</span><span class="o">=</span><span class="s2">&quot;BackgroundUpdateData2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">periodic_task</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">convert_data</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">name</span><span class="o">=</span><span class="s2">&quot;BackgroundUpdateData3&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="c1">#stationUpdateHandler = threading.Thread(target=periodic_task, args=(update_station, 5), daemon=True, name=&quot;BackgroundUpdateStation&quot;)</span>
        <span class="c1">#stationUpdateHandler.start()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;get_simulation_online&quot;</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/online/smbstation&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">get_SMB_online</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get response function for /online/smbstation, returns smb station page of online sim&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">running</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;SMBStation.html&#39;</span><span class="p">,</span> <span class="n">stationInfo</span><span class="o">=</span><span class="n">station</span><span class="o">.</span><span class="n">getColInfo</span><span class="p">(),</span> <span class="n">readyNext</span><span class="o">=</span><span class="n">station</span><span class="o">.</span><span class="n">getZoneReady</span><span class="p">(),</span>
                               <span class="n">formInfo</span><span class="o">=</span><span class="n">formInfo</span><span class="p">,</span> <span class="n">running</span><span class="o">=</span><span class="n">running</span><span class="p">,</span> <span class="n">online</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/online/connection&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">get_dataservice_connection</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get response function for /online/connection, returns if Data Service connection is live&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">check_dataservice_connection</span><span class="p">(</span><span class="n">login_to_Dataservice</span><span class="p">()):</span>
            <span class="k">return</span> <span class="s2">&quot;Yes&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;No&quot;</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/online/column&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">post_add_column_online</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;http post response function for /online/column, adds column to smb station&quot;&quot;&quot;</span>
        <span class="n">add_column</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;get_SMB_online&#39;</span><span class="p">))</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    @api.route(&#39;/smbstation/components/simconfig/simulation/data&#39;, methods=[&#39;GET&#39;])</span>
<span class="sd">    def get_simulation_data():</span>
<span class="sd">        nonlocal station</span>
<span class="sd">        responseDict = {}</span>
<span class="sd">        responseDict[&quot;compList&quot;] = list(station.getCompInfo().keys())</span>
<span class="sd">        resList10 = []</span>
<span class="sd">        for ii in range(10):</span>
<span class="sd">            res = station.step()</span>
<span class="sd">            resList10.append(res)</span>
<span class="sd">        responseDict[&quot;data&quot;] = resList10</span>
<span class="sd">        return json.dumps(responseDict)&#39;&#39;&#39;</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/offline/smbstation/components/simconfig/simulation/flowrate&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">post_simulation_flowrate</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP post response function for /offline/smbstation/components/simconfig/simulation/flowrate, updates flow rates of smb station&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">station_lock</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;zone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRateZone&quot;</span><span class="p">))</span>
            <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;zone&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRate&quot;</span><span class="p">))</span>
            <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">station</span><span class="o">.</span><span class="n">setFlowRateZone</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;zone&quot;</span><span class="p">],</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;zone&quot;</span><span class="p">])])</span>
                <span class="n">station</span><span class="o">.</span><span class="n">initCols</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;Success&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;Fail&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/offline/smbstation/components/simconfig/simulation/switch&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">post_simulation_switch</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP post response function for /offline/smbstation/components/simconfig/simulation/switch, updates switch interval of smb station&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">station_lock</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;switch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;switch&quot;</span><span class="p">))</span>
            <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">station</span><span class="o">.</span><span class="n">setSwitchInterval</span><span class="p">(</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;switch&quot;</span><span class="p">])</span>
                <span class="n">station</span><span class="o">.</span><span class="n">initCols</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;Success&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;Fail&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/online/smbstation/components/simconfig/simulation/change&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">post_simulation_change_online</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP post response function for /online/smbstation/components/simconfig/simulation/change, &quot;soft&quot; updates online sim parameters&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">stationSaveState</span><span class="p">,</span> <span class="n">station_lock</span>
        <span class="n">stationSaveState</span><span class="p">[</span><span class="s2">&quot;horizon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;horizon&quot;</span><span class="p">]</span>
        <span class="n">stationSaveState</span><span class="p">[</span><span class="s2">&quot;countdown&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;horizon&quot;</span><span class="p">]</span>
        <span class="n">stationSaveState</span><span class="p">[</span><span class="s2">&quot;flowRate1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate1&quot;</span><span class="p">]</span>
        <span class="n">stationSaveState</span><span class="p">[</span><span class="s2">&quot;flowRate2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate2&quot;</span><span class="p">]</span>
        <span class="n">stationSaveState</span><span class="p">[</span><span class="s2">&quot;flowRate3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate3&quot;</span><span class="p">]</span>
        <span class="n">stationSaveState</span><span class="p">[</span><span class="s2">&quot;flowRate4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate4&quot;</span><span class="p">]</span>
        <span class="n">stationSaveState</span><span class="p">[</span><span class="s2">&quot;switchInterval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;switchInterval&quot;</span><span class="p">]</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateEluent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRateEluent&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateExtract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRateExtract&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateFeed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRateFeed&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateRaffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRateRaffinate&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateRecycle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRateRecycle&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;switchInterval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;switch&quot;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fix_flowrates</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Flow Rates don&#39;t match.&quot;</span>
        <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;lastChange&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">timer</span>
            <span class="n">stationSaveState</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">deepCopy</span><span class="p">()</span>
            <span class="n">compList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">getCompInfo</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">compList</span><span class="p">:</span>
                <span class="n">station</span><span class="o">.</span><span class="n">updateComponentByName</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">comp</span><span class="p">,</span> <span class="n">feedConc</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;feedConc&quot;</span><span class="o">+</span><span class="n">comp</span><span class="p">))</span><span class="o">*</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;concUnits&quot;</span><span class="p">])</span>
            <span class="n">update_station</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;Success&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/online/smbstation/components/simconfig/simulation/forcechange&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">post_simulation_force_change_online</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP post response function for /online/smbstation/components/simconfig/simulation/forcechange, &quot;force&quot; updates online sim parameters&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">stationSaveState</span><span class="p">,</span> <span class="n">station_lock</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateEluent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRateEluent&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateExtract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRateExtract&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateFeed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRateFeed&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateRaffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRateRaffinate&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateRecycle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowRateRecycle&quot;</span><span class="p">))</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;switchInterval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;switch&quot;</span><span class="p">))</span>
        <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;lastChange&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">timer</span>
            <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;secondLastChange&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">timer</span>
            <span class="n">compList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">getCompInfo</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">compList</span><span class="p">:</span>
                <span class="n">station</span><span class="o">.</span><span class="n">updateComponentByName</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">comp</span><span class="p">,</span> <span class="n">feedConc</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;feedConc&quot;</span><span class="o">+</span><span class="n">comp</span><span class="p">))</span><span class="o">*</span><span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;concUnits&quot;</span><span class="p">])</span>
            <span class="n">fix_flowrates</span><span class="p">()</span>
            <span class="n">update_station</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">send_to_PLC</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;Success&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

    <span class="n">MQTT_USER</span> <span class="o">=</span> <span class="s2">&quot;edge&quot;</span>
    <span class="n">MQTT_PASSWORD</span> <span class="o">=</span> <span class="s2">&quot;edge&quot;</span>
    <span class="n">MQTT_IP</span> <span class="o">=</span> <span class="s2">&quot;ie-databus&quot;</span>
    <span class="n">MQTT_PORT</span> <span class="o">=</span> <span class="mi">1883</span>
    <span class="n">TOPIC</span> <span class="o">=</span> <span class="s2">&quot;ie/d/j/simatic/v1/s7c1/dp/w/PLC0&quot;</span>
    <span class="n">TOPIC2</span> <span class="o">=</span> <span class="s2">&quot;ie/m/j/simatic/v1/s7c1/dp&quot;</span>
    <span class="n">mqtt_sequence</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">mqtt</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
    <span class="n">client</span><span class="o">.</span><span class="n">username_pw_set</span><span class="p">(</span><span class="n">MQTT_USER</span><span class="p">,</span> <span class="n">MQTT_PASSWORD</span><span class="p">)</span>
    <span class="n">client</span><span class="o">.</span><span class="n">on_connect</span> <span class="o">=</span> <span class="n">on_connect</span>
    <span class="n">client</span><span class="o">.</span><span class="n">on_message</span> <span class="o">=</span> <span class="n">on_message</span>
    <span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">MQTT_IP</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">MQTT_PORT</span><span class="p">)</span>
    <span class="n">client</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">TOPIC2</span><span class="p">)</span>
    <span class="n">client</span><span class="o">.</span><span class="n">loop_start</span><span class="p">()</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/online/smbstation/components/simconfig/simulation/change/keep&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">post_simulation_change_keep_online</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP post response function for /online/smbstation/components/simconfig/simulation/change/keep, keeps &quot;soft&quot; updade&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">stationSaveState</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;secondLastChange&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;lastChange&quot;</span><span class="p">]</span>
        <span class="n">send_to_PLC</span><span class="p">()</span>
        <span class="n">stationSaveState</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;Success&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_to_PLC</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Publish parameter update message to mqtt client&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">mqtt_sequence</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">tagMap</span><span class="p">,</span> <span class="n">tagIdMap</span><span class="p">,</span> <span class="n">TOPIC</span><span class="p">,</span> <span class="n">client</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;seq&quot;</span><span class="p">:</span> <span class="n">mqtt_sequence</span><span class="p">,</span> <span class="s2">&quot;vals&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">mqtt_sequence</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">timeStamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;Z&quot;</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;vals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">tagIdMap</span><span class="p">[</span><span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;eluent&quot;</span><span class="p">]],</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateEluent&quot;</span><span class="p">],</span> <span class="s2">&quot;ts&quot;</span><span class="p">:</span> <span class="n">timeStamp</span><span class="p">,</span> <span class="s2">&quot;qc&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;vals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">tagIdMap</span><span class="p">[</span><span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;extract&quot;</span><span class="p">]],</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateExtract&quot;</span><span class="p">],</span> <span class="s2">&quot;ts&quot;</span><span class="p">:</span> <span class="n">timeStamp</span><span class="p">,</span> <span class="s2">&quot;qc&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;vals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">tagIdMap</span><span class="p">[</span><span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;feed&quot;</span><span class="p">]],</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateFeed&quot;</span><span class="p">],</span> <span class="s2">&quot;ts&quot;</span><span class="p">:</span> <span class="n">timeStamp</span><span class="p">,</span> <span class="s2">&quot;qc&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;vals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">tagIdMap</span><span class="p">[</span><span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]],</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateRaffinate&quot;</span><span class="p">],</span> <span class="s2">&quot;ts&quot;</span><span class="p">:</span> <span class="n">timeStamp</span><span class="p">,</span> <span class="s2">&quot;qc&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;vals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">tagIdMap</span><span class="p">[</span><span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;recycle&quot;</span><span class="p">]],</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRateRecycle&quot;</span><span class="p">],</span> <span class="s2">&quot;ts&quot;</span><span class="p">:</span> <span class="n">timeStamp</span><span class="p">,</span> <span class="s2">&quot;qc&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;vals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">tagIdMap</span><span class="p">[</span><span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;switchInterval&quot;</span><span class="p">]],</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;switchInterval&quot;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;ts&quot;</span><span class="p">:</span> <span class="n">timeStamp</span><span class="p">,</span> <span class="s2">&quot;qc&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
        <span class="n">compInfo</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">getCompInfo</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">comp</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">compInfo</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">message</span><span class="p">[</span><span class="s2">&quot;vals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">tagIdMap</span><span class="p">[</span><span class="n">tagMap</span><span class="p">[</span><span class="s2">&quot;feed&quot;</span> <span class="o">+</span> <span class="n">comp</span><span class="p">]],</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;Feed Concentration&quot;</span><span class="p">],</span> <span class="s2">&quot;ts&quot;</span><span class="p">:</span> <span class="n">timeStamp</span><span class="p">,</span> <span class="s2">&quot;qc&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="n">client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">TOPIC</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/online/smbstation/components/simconfig/simulation/change/notkeep&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">post_simulation_change_notkeep_online</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP post response function for /online/smbstation/components/simconfig/simulation/change/notkeep, rollback &quot;soft&quot; updade&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">formInfo</span><span class="p">,</span> <span class="n">stationSaveState</span><span class="p">,</span> <span class="n">station_lock</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stationSaveState</span><span class="p">[</span><span class="s2">&quot;flowRate1&quot;</span><span class="p">]</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stationSaveState</span><span class="p">[</span><span class="s2">&quot;flowRate2&quot;</span><span class="p">]</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stationSaveState</span><span class="p">[</span><span class="s2">&quot;flowRate3&quot;</span><span class="p">]</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;flowRate4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stationSaveState</span><span class="p">[</span><span class="s2">&quot;flowRate4&quot;</span><span class="p">]</span>
        <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;switchInterval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stationSaveState</span><span class="p">[</span><span class="s2">&quot;switchInterval&quot;</span><span class="p">]</span>
        <span class="n">station_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;lastChange&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;secondLastChange&quot;</span><span class="p">]</span>
            <span class="n">station</span> <span class="o">=</span> <span class="n">stationSaveState</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span>
            <span class="n">responseDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;compList&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">getCompInfo</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;compList&quot;</span><span class="p">])):</span>
                <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">stationSaveState</span><span class="p">[</span><span class="s2">&quot;horizon&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">stationSaveState</span><span class="p">[</span><span class="s2">&quot;countdown&quot;</span><span class="p">],</span> <span class="n">formInfo</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]):</span>  <span class="c1"># loop for each time step</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>  <span class="c1"># step</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># loop through components in last column in zone 1</span>
                    <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;extract&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># append last conc value of given component</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># loop through components in last column in zone 3</span>
                    <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;raffinate&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># append last conc value of given component</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">station_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">onlineMemory</span><span class="p">[</span><span class="s2">&quot;horizon&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">responseDict</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
        <span class="n">stationSaveState</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">responseDict</span><span class="p">)</span>


    <span class="nd">@api</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/offline/smbstation/components/simconfig/simulation&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="nd">@flask_login</span><span class="o">.</span><span class="n">login_required</span>
    <span class="k">def</span> <span class="nf">get_simulation</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP get response function for /offline/smbstation/components/simconfig/simulation, response offline sim page&quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">station</span><span class="p">,</span> <span class="n">running</span><span class="p">,</span> <span class="n">formInfo</span>
        <span class="n">station</span><span class="o">.</span><span class="n">initCols</span><span class="p">()</span>
        <span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;OfflineSimulationPage.html&#39;</span><span class="p">,</span> <span class="n">formInfo</span><span class="o">=</span><span class="n">formInfo</span><span class="p">,</span> <span class="n">colInfo</span><span class="o">=</span><span class="n">station</span><span class="o">.</span><span class="n">getColInfo</span><span class="p">())</span>

    <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PORT&#39;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">))</span>
    <span class="n">api</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">SMB-Sim</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../main.html">main module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">SMB-Sim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SMB.html">SMB package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Adam Svoboda.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>